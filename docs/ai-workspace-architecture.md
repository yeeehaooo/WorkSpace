# Enterprise AI Workspace Architecture (v1.2)

## Goals

- Provide a **tool-agnostic governance core** (Source of Truth)
- Provide **reusable skill packs** that scale across many repositories
- Keep tool-specific behavior isolated in **adapters**
- Enable **fast activation** of relevant skills based on detected tech stack
- Support **project-level overrides** without breaking governance
- Avoid performance regressions in large workspaces via caching

---

## Folder Responsibilities

### /agent (Governance Core)
**Source of Truth** for AI behaviors and engineering policies.

- Tool-agnostic rules only
- Architecture principles (Clean Architecture / CQRS)
- Naming, exception policy, security guidance
- Governance freeze policy and versioning

**Must NOT contain**
- Tool-specific instructions
- Project-specific rules
- Large implementation snippets (belongs to skills)

---

### /skills (Reusable Skill Packs)
Reusable implementation playbooks.

- Templates (scaffolds, snippets)
- Patterns (Domain, Repository, Module layout)
- Performance guidance
- Shared docs/debug playbooks

**Versioned independently** via `/skills/meta/version.md`.

**Must NOT contain**
- Governance rules (belongs to agent)
- Tool adapter behavior (belongs to adapters)

---

### /adapters (Tool Adapter Layer)
Specifications that map governance/skills into each tool.

- Cursor mappings
- Skill detection spec
- Future: Claude adapter, VSCode adapter

**Must NOT contain**
- Source-of-truth governance content
- Reusable skill packs
- Project-specific rules

---

### /tools (Automation)
Automation scripts that generate adapter artifacts.

- Skill detection and activation generation
- Cache files
- Logs

---

### /.cursor/rules (Cursor Adapter Rules)
**Only adapters**: short, stable loader rules.

- bootstrap
- priority order
- governance summary pointer
- skill loading pointer
- auto-generated active skills list

---

## Rule Priority Order

1) `/agent/**` governance policies (highest priority)
2) Skills listed by active skill files (workspace/project)
3) Project-specific rules within the project repo
4) Local overrides (lowest)

Never override governance silently.

---

## Skill Loading Mechanism

### Workspace-level activation
- `.cursor/rules/90-active-skills.mdc` lists skill packs enabled for the workspace.
- Generated by `tools/update-cursor-skills.ps1`.

### Per-project skill isolation (v1.2)
- For each project under `Projects/<proj>` the tooling generates:
  - `Projects/<proj>/.cursor/rules/90-active-skills.mdc`
- This file is used when opening that project repo in the IDE.
- This enables **project-specific activation** without polluting other projects.

---

## Tech Detection Signals

### .NET
- `*.sln`, `*.slnx`, `*.csproj`, `Directory.Build.props`, `global.json`

### Frontend
- `package.json`, `pnpm-lock.yaml`, `yarn.lock`

### Java
- `pom.xml`, `build.gradle`, `settings.gradle`

Multiple technologies may be enabled simultaneously (additive).

---

## Project-level Overrides

Project can add:
- `Projects/<ProjectName>/.ai/skills.json`

Example:
```json
{
  "add": ["skills/performance", "skills/frontend"],
  "remove": ["skills/java"]
}
```

**Rules:**
- `add`/`remove` values are skill paths without leading `/`
- `skills/_shared` cannot be removed (hard rule)
- Overrides affect only that project (per-project isolation)

**(Optional) Workspace-level override:**
- `.ai/skills.json` at workspace root can affect workspace activation only.

---

## Cache Mechanism

The tooling avoids full scans by storing:
- `tools/.skill-cache.json`

**Signature includes:**
- limited tech signal sampling timestamps
- override files timestamps
- key workspace configs (`agent/meta/version.md`, `adapters/cursor/skill-detection.md`)

**If signature unchanged:**
- reuse cache and skip scanning

---

## Conflict Resolution Report (v1.2)

Tool generates a report in console + `tools/skill-detection.log`:
- Added skills (from override)
- Removed skills (from override)
- Blocked operations (hard rule violations or invalid JSON)
- Which override files were applied

---

## Outputs

**Generated files:**
- Workspace: `.cursor/rules/90-active-skills.mdc`
- Projects: `Projects/<proj>/.cursor/rules/90-active-skills.mdc`
- Logs: `tools/skill-detection.log`
- Cache: `tools/.skill-cache.json`

---

## Future Extensions

- Machine-readable report output (JSON)
- Skill conflict policies (warn-only rule sets)
- Per-project "pin" of skill versions
- Adapter expansion: Claude, VSCode tasks, MCP tooling integration
